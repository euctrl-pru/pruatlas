---
title: "EUROCONTROL Maps"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{EUROCONTROL Maps}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(pruatlas)
library(dplyr)
library(sf)
library(ggplot2)
library(stringr)
library(readr)
library(purrr)
```

## Single Country FIR
Let's plot Italian FIR at FL300

```{r italy}
plot_country_fir("LI", "Italy", fl = 300)
```

For UK, things are more complicated because it has also an Oceanic bit of volume
```{r uk}
plot_country_fir("EG", "UK (oceanic)", fl = 200)
```

So to plot the *continental* part only we need to split things:
```{r uk-continental}
uk_continental <- firs_nm_406 %>%
  dplyr::filter(icao == "EG", min_fl <= 0, 0 <= max_fl) %>%
  dplyr::filter(!(id %in% c("EGGXFIR", "EGGX")))
plot_country_fir(
  "EG",
  "UK (continental)",
  firs = uk_continental,
  fl = 200)
```



## EUROCONTROL

### Merged Member States FIRs

For plotting EUROCONTROL Member States' FIR area we can select and
merge the various airspaces:

```{r eurocontrol}
plot_country_fir(icao_id = "E.|L.|UD|UG|GM|UK|GC",
                 "EUROCONTROL",
                 buffer = 350,
                 fl = 200)
```

### All Member States FIRs

```{r member-states}
ms_codes <- member_states %>% 
  # filter out Germany (military, no specific FIR),
  #   Luxembourg (managed by Belgium) and Monaco (managed by France)
  filter(!icao %in% c("ET", "EL", "LN")) %>% 
  pull(icao) %>% 
  sort() %>% 
  unique()

ms_firs <- ms_codes %>% 
  purrr::map_dfr(~ suppressMessages(
    country_fir(pruatlas::firs_nm_406, icao_id = .x))) %>% 
  mutate(id = str_sub(id, 1, 2)) %>%
  left_join(member_states, by = c("id" = "icao")) %>% 
  mutate(
    name = case_when(
      id == "EB" ~ "Belgium and Luxemburg",
      id == "LF" ~ "France and Monaco",
      id == "EG" ~ "United Kingdom",
      TRUE       ~ name),
    icao = id,
    min_fl = 200,
    max_fl = 200)

plot_country_fir(firs = ms_firs,
                 icao_id = ms_codes,
                 fl = 200,
                 name = "EUROCONTROL",
                 merge = FALSE)
```

### CRCO Charging Zones

You can get the CRCO charging zones boundaries from
[EUROCONTROL web site](https://www.eurocontrol.int/publication/route-state-overflown-rso-distance-tool-area-boundary-model).
This package stores a real file as an example.

```{r, crco}
bo <- system.file("extdata", "sbm_bz_20200527.txt", package = "pruatlas")
crco <- readr::read_lines(bo) %>%
  parse_airspace_crco() %>% 
  mutate(icao = unit)
codes <- crco %>% pull(icao) %>% unique()

# country_fir(firs = crco,
#             icao_id = "E.|L.|UD|UG|GM|UK|GC",
#             fl = 200, merge = FALSE)
# 
# ggplot(crco) + geom_sf()

plot_country_fir(firs = crco,
                 fl = 200,
                 icao_id = codes,
                 name = "CRCO charging zones",
                 merge = FALSE)
```

## STATFOR Areas

### ECAC North West

```{r ecac-nw}
ecac_nw <- ecac_northwest() %>% 
  sf::st_as_sf() %>%
  sf::st_union() %>%
  sf::st_sf(geometry = .,
            id = "ECAC_NW",
            icao = "ECAC_NW",
            name = "ECAC North West") %>% 
  mutate(min_fl = 0, max_fl = 999)
plot_country_fir(icao_id = "ECAC_NW", name = "ECAC North West", firs = ecac_nw)
```


### ECAC Oceanic

```{r, ecac-oc}
ecac_oc <- ecac_oceanic() %>% 
  sf::st_as_sf() %>%
  sf::st_union() %>%
  sf::st_sf(geometry = .,
            id = "ECAC_OC",
            name = "ECAC Oceanic",
            icao = "ECAC_OC"
            ) %>% 
  mutate(min_fl = 0, max_fl = 999)
plot_country_fir(icao_id = "ECAC_OC", name = "ECAC Oceanic", firs = ecac_oc)
```


### ECAC South West

```{r ecac-sw}
ecac_sw <- ecac_southeast() %>% 
  sf::st_as_sf() %>%
  sf::st_union() %>%
  sf::st_sf(geometry = .,
            id = "ECAC_SW",
            name = "ECAC South West",
            icao = "ECAC_SW"
            ) %>% 
  mutate(min_fl = 0, max_fl = 999)
plot_country_fir(icao_id = "ECAC_SW", name = "ECAC South West", firs = ecac_sw)
```


### ECAC North East

```{r, ecac-ne}
ecac_ne <- ecac_northeast() %>% 
  sf::st_as_sf() %>%
  sf::st_union() %>%
  sf::st_sf(geometry = .,
            id = "ECAC_NE",
            name = "ECAC North East",
            icao = "ECAC_NE"
            ) %>% 
  mutate(min_fl = 0, max_fl = 999)
plot_country_fir(icao_id = "ECAC_NE",
                 name = "ECAC North East",
                 firs = ecac_ne)
```

### ECAC South East

```{r, ecac-se}
ecac_se <- ecac_southeast() %>% 
    sf::st_as_sf() %>%
    sf::st_union() %>%
  sf::st_sf(geometry = .,
            id = "ECAC_SE",
            name = "ECAC South East",
            icao = "ECAC_SE"
            ) %>% 
  mutate(min_fl = 0, max_fl = 999)
plot_country_fir(icao_id = "ECAC_SE", name = "ECAC South East", firs = ecac_se)
```

### Complete ECAC

```{r, ecac-whole}
ecac <- list(ecac_oceanic(),
             ecac_northwest(),
             ecac_southhwest(),
             ecac_southeast(),
             ecac_northeast()
             ) %>% 
  purrr::map_dfr(.f = bind_rows)
    sf::st_as_sf() %>%
    sf::st_union() %>%
  sf::st_sf(geometry = .,
            id = "ECAC",
            name = "ECAC",
            icao = "ECAC"
            ) %>% 
  mutate(min_fl = 0, max_fl = 999)
plot_country_fir(icao_id = "ECAC", name = "ECAC", firs = ecac)
```
